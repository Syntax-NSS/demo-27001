<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pruebas de Continuidad</title>
    <link rel="stylesheet" href="../css/global.css" />
    <link rel="stylesheet" href="../css/components.css" />
    <style>
      body {
        background-color: var(--color-background);
      }
      .main-content {
        margin-left: 90px;
      }
      .page-header {
        padding: 20px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .page-title {
        font-size: 32px;
        font-weight: 600;
      }
      .summary-grid {
        margin: 0 40px 30px 40px;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
      }
      .summary-card {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: var(--shadow-sm);
      }
      .summary-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 16px;
      }
      .summary-icon.green {
        background-color: var(--color-success-bg);
      }
      .summary-icon.orange {
        background-color: var(--color-warning-bg);
      }
      .summary-icon.blue {
        background-color: var(--color-info-bg);
      }
      .summary-icon.purple {
        background-color: #f3e8ff;
      }
      .summary-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
      }
      .summary-label {
        font-size: 14px;
        color: var(--color-text-muted);
      }
      .timeline-container {
        margin: 0 40px;
        background-color: #ffffff;
        border-radius: 12px;
        padding: 30px;
        box-shadow: var(--shadow-sm);
      }
      .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .timeline-title {
        font-size: 20px;
        font-weight: 600;
      }
      .timeline {
        position: relative;
        padding: 20px 0;
      }
      .timeline-line {
        position: absolute;
        left: 30px;
        top: 40px;
        bottom: 40px;
        width: 2px;
        background-color: var(--color-border);
      }
      .timeline-item {
        position: relative;
        padding-left: 80px;
        margin-bottom: 40px;
      }
      .timeline-marker {
        position: absolute;
        left: 18px;
        top: 8px;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
      }
      .timeline-marker.completed {
        background-color: var(--color-success);
        border: 3px solid var(--color-success-light);
        color: white;
        font-size: 14px;
      }
      .timeline-marker.upcoming {
        background-color: var(--color-warning);
        border: 3px solid var(--color-warning-light);
        color: white;
        font-size: 14px;
      }
      .timeline-marker.pending {
        background-color: #cbd5e0;
        border: 3px solid #f0f4f8;
        color: white;
        font-size: 14px;
      }
      .timeline-content {
        background-color: #f8fafb;
        border-radius: 12px;
        padding: 24px;
        border: 1px solid var(--color-border);
        transition: box-shadow 0.2s;
        cursor: pointer;
      }
      .timeline-content:hover {
        box-shadow: var(--shadow-md);
      }
      .timeline-date {
        font-size: 12px;
        font-weight: 600;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }
      .timeline-test-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
      }
      .timeline-description {
        font-size: 14px;
        color: var(--color-text-secondary);
        line-height: 1.6;
        margin-bottom: 16px;
      }
      .timeline-meta {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
      }
      .meta-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .meta-label {
        font-size: 12px;
        color: var(--color-text-muted);
      }
      .meta-value {
        font-size: 14px;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div id="sidebar"></div>
    <div class="main-content">
      <div id="header"></div>
      <div id="breadcrumb"></div>
      <div class="page-header">
        <div class="page-title">Pruebas de Continuidad del Negocio</div>
        <button class="btn btn-primary" onclick="showPruebaForm()">
          + Programar nueva prueba
        </button>
      </div>
      <div class="summary-grid" id="summaryGrid"></div>
      <div class="timeline-container">
        <div class="timeline-header">
          <div class="timeline-title">Calendario de Pruebas 2024-2025</div>
        </div>
        <div class="timeline">
          <div class="timeline-line"></div>
          <div id="timelineItems"></div>
        </div>
      </div>
    </div>

    <!-- Modal Formulario Prueba de Continuidad -->
    <div
      id="pruebaFormModal"
      class="modal-overlay"
      style="display: none"
      onclick="closeModalOnOverlayClick(event, 'pruebaFormModal')"
    >
      <div
        class="modal"
        onclick="event.stopPropagation()"
        style="max-width: 820px"
      >
        <div class="modal-header">
          <h3 class="modal-title" id="pruebaModalTitle">
            Nueva Prueba de Continuidad
          </h3>
          <button class="modal-close" onclick="closeModal('pruebaFormModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <form id="pruebaForm">
            <input type="hidden" id="pruebaId" />
            <div class="form-group">
              <label class="form-label required">T√≠tulo</label>
              <input
                type="text"
                class="form-control"
                id="pruebaTitulo"
                required
              />
              <span class="form-error"></span>
            </div>

            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px"
            >
              <div class="form-group">
                <label class="form-label required">Fecha</label>
                <input
                  type="date"
                  class="form-control"
                  id="pruebaFecha"
                  required
                />
                <span class="form-error"></span>
              </div>
              <div class="form-group">
                <label class="form-label required">Responsable</label>
                <input
                  type="text"
                  class="form-control"
                  id="pruebaResponsable"
                  required
                />
                <span class="form-error"></span>
              </div>
            </div>

            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-top: 12px;
              "
            >
              <div class="form-group">
                <label class="form-label">Duraci√≥n</label>
                <input
                  type="text"
                  class="form-control"
                  id="pruebaDuracion"
                  placeholder="e.j. 4 horas"
                />
              </div>
              <div class="form-group">
                <label class="form-label required">Estado</label>
                <select class="form-control" id="pruebaEstado" required>
                  <option value="planificada">Planificada</option>
                  <option value="proxima">Pr√≥xima</option>
                  <option value="completada">Completada</option>
                </select>
              </div>
            </div>

            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-top: 12px;
              "
            >
              <div class="form-group">
                <label class="form-label">Resultado</label>
                <select class="form-control" id="pruebaResultado">
                  <option value="">--</option>
                  <option value="exitosa">Exitosa</option>
                  <option value="parcial">Parcial</option>
                  <option value="fallida">Fallida</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Hallazgos</label>
                <input type="text" class="form-control" id="pruebaHallazgos" />
              </div>
            </div>

            <div class="form-group" style="margin-top: 12px">
              <label class="form-label"
                >Lecciones aprendidas / Observaciones</label
              >
              <textarea
                class="form-control"
                id="pruebaLecciones"
                rows="3"
              ></textarea>
            </div>

            <div class="form-group" style="margin-top: 12px">
              <label class="form-label">Descripci√≥n</label>
              <textarea
                class="form-control"
                id="pruebaDescripcion"
                rows="3"
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <div style="margin-right: auto">
            <button
              id="deletePruebaBtn"
              class="btn btn-danger"
              style="display: none"
              onclick="confirmDeletePrueba()"
            >
              Eliminar
            </button>
          </div>
          <button
            class="btn btn-secondary"
            onclick="closeModal('pruebaFormModal')"
          >
            Cancelar
          </button>
          <button class="btn btn-primary" onclick="savePrueba()">
            Guardar
          </button>
        </div>
      </div>
    </div>
    <script src="../js/storage.js"></script>
    <script src="../js/components.js"></script>
    <script>
      document.getElementById("sidebar").innerHTML = renderSidebar("pruebas");
      document.getElementById("header").innerHTML = renderHeader();
      document.getElementById("breadcrumb").innerHTML = renderBreadcrumb([
        { icon: "üè†", text: "Inicio", link: "../index.html" },
        { text: "Gesti√≥n de Calidad" },
        { text: "Pruebas de Continuidad" },
      ]);

      function loadSummary() {
        const data = storage.getAll("pruebas_continuidad");
        const completadas = data.filter(
          (p) => p.estado === "completada"
        ).length;
        const planificadas = data.filter(
          (p) => p.estado === "planificada" || p.estado === "proxima"
        ).length;
        const exitosas = data.filter((p) => p.resultado === "exitosa").length;
        const tasaExito =
          completadas > 0 ? Math.round((exitosas / completadas) * 100) : 0;

        document.getElementById("summaryGrid").innerHTML = `
                <div class="summary-card"><div class="summary-icon green">‚úì</div><div class="summary-value">${completadas}</div><div class="summary-label">Realizadas</div></div>
                <div class="summary-card"><div class="summary-icon orange">‚è∞</div><div class="summary-value">${planificadas}</div><div class="summary-label">Planificadas</div></div>
                <div class="summary-card"><div class="summary-icon blue">üìã</div><div class="summary-value">${data.length}</div><div class="summary-label">Total anual</div></div>
                <div class="summary-card"><div class="summary-icon purple">%</div><div class="summary-value">${tasaExito}%</div><div class="summary-label">Tasa de √©xito</div></div>
            `;
      }

      function loadPruebas() {
        const data = storage
          .getAll("pruebas_continuidad")
          .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
        const markerMap = {
          completada: "completed",
          proxima: "upcoming",
          planificada: "pending",
        };
        const markerIcons = {
          completada: "‚úì",
          proxima: "‚è∞",
          planificada: "‚óã",
        };
        const estadoLabels = {
          completada: "Completada",
          proxima: "Pr√≥xima",
          planificada: "Planificada",
        };
        const estadoColors = {
          completada: "success",
          proxima: "warning",
          planificada: "info",
        };
        const resultadoLabels = {
          exitosa: "Exitosa",
          parcial: "Parcial",
          fallida: "Fallida",
        };
        const resultadoColors = {
          exitosa: "success",
          parcial: "warning",
          fallida: "danger",
        };

        document.getElementById("timelineItems").innerHTML = data
          .map(
            (prueba) => `
                <div class="timeline-item" onclick="editPrueba('${prueba.id}')">
                    <div class="timeline-marker ${markerMap[prueba.estado]}">${
              markerIcons[prueba.estado]
            }</div>
                    <div class="timeline-content">
                        <div class="timeline-date">${formatDate(
                          prueba.fecha
                        )}</div>
                        <div class="timeline-test-title">${prueba.titulo}</div>
                        <div class="timeline-description">${
                          prueba.descripcion
                        }</div>
                        <div class="timeline-meta">
                            <div class="meta-item"><div class="meta-label">Responsable</div><div class="meta-value">${
                              prueba.responsable
                            }</div></div>
                            <div class="meta-item"><div class="meta-label">${
                              prueba.estado === "completada"
                                ? "Duraci√≥n"
                                : "Duraci√≥n estimada"
                            }</div><div class="meta-value">${
              prueba.duracion
            }</div></div>
                            <div class="meta-item"><div class="meta-label">Estado</div><span class="badge badge-${
                              estadoColors[prueba.estado]
                            }">${estadoLabels[prueba.estado]}</span></div>
                            ${
                              prueba.resultado
                                ? `<div class="meta-item"><div class="meta-label">Resultado</div><span class="badge badge-${
                                    resultadoColors[prueba.resultado]
                                  }">${
                                    resultadoLabels[prueba.resultado]
                                  }</span></div>`
                                : ""
                            }
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function showPruebaForm() {
        document.getElementById("pruebaModalTitle").textContent =
          "Nueva Prueba de Continuidad";
        if (typeof clearForm === "function") clearForm("pruebaForm");
        document.getElementById("pruebaId").value = "";
        document.getElementById("pruebaTitulo").value = "";
        document.getElementById("pruebaFecha").value = new Date()
          .toISOString()
          .split("T")[0];
        document.getElementById("pruebaResponsable").value = "";
        document.getElementById("pruebaDuracion").value = "";
        document.getElementById("pruebaEstado").value = "planificada";
        document.getElementById("pruebaResultado").value = "";
        document.getElementById("pruebaHallazgos").value = "";
        document.getElementById("pruebaLecciones").value = "";
        document.getElementById("pruebaDescripcion").value = "";
        document.getElementById("deletePruebaBtn").style.display = "none";
        openModal && openModal("pruebaFormModal");
      }

      function editPrueba(id) {
        const prueba = storage.getById("pruebas_continuidad", id);
        if (!prueba) {
          showAlert && showAlert("Prueba no encontrada", "error");
          return;
        }
        document.getElementById("pruebaModalTitle").textContent =
          "Editar Prueba de Continuidad";
        if (typeof clearForm === "function") clearForm("pruebaForm");

        document.getElementById("pruebaId").value = prueba.id || "";
        document.getElementById("pruebaTitulo").value = prueba.titulo || "";
        document.getElementById("pruebaFecha").value = prueba.fecha || "";
        document.getElementById("pruebaResponsable").value =
          prueba.responsable || "";
        document.getElementById("pruebaDuracion").value = prueba.duracion || "";
        document.getElementById("pruebaEstado").value =
          prueba.estado || "planificada";
        document.getElementById("pruebaResultado").value =
          prueba.resultado || "";
        document.getElementById("pruebaHallazgos").value =
          prueba.hallazgos || "";
        document.getElementById("pruebaLecciones").value =
          prueba.leccionesAprendidas || "";
        document.getElementById("pruebaDescripcion").value =
          prueba.descripcion || "";

        document.getElementById("deletePruebaBtn").style.display =
          "inline-block";
        openModal && openModal("pruebaFormModal");
      }

      function savePrueba() {
        // Prefer existing validateForm helper if available
        if (typeof validateForm === "function") {
          if (!validateForm("pruebaForm")) return;
        } else {
          // minimal validation
          const titulo = document.getElementById("pruebaTitulo").value.trim();
          const fecha = document.getElementById("pruebaFecha").value;
          const responsable = document
            .getElementById("pruebaResponsable")
            .value.trim();
          if (!titulo || !fecha || !responsable) {
            showAlert &&
              showAlert("T√≠tulo, fecha y responsable son requeridos", "error");
            return;
          }
        }

        const id = document.getElementById("pruebaId").value;
        const data = {
          titulo: document.getElementById("pruebaTitulo").value,
          fecha: document.getElementById("pruebaFecha").value,
          descripcion: document.getElementById("pruebaDescripcion").value,
          responsable: document.getElementById("pruebaResponsable").value,
          duracion: document.getElementById("pruebaDuracion").value,
          estado: document.getElementById("pruebaEstado").value,
          resultado: document.getElementById("pruebaResultado").value,
          hallazgos: document.getElementById("pruebaHallazgos").value,
          leccionesAprendidas: document.getElementById("pruebaLecciones").value,
          fechaActualizacion: new Date().toISOString().split("T")[0],
        };

        if (id) {
          storage.update("pruebas_continuidad", id, data);
          showAlert && showAlert("Prueba actualizada exitosamente", "success");
        } else {
          storage.create("pruebas_continuidad", data);
          showAlert && showAlert("Prueba creada exitosamente", "success");
        }

        closeModal && closeModal("pruebaFormModal");
        loadSummary();
        loadPruebas();
      }

      function confirmDeletePrueba() {
        const id = document.getElementById("pruebaId").value;
        if (!id) return;
        if (confirm("¬øEst√° seguro de eliminar esta prueba de continuidad?")) {
          storage.delete("pruebas_continuidad", id);
          showAlert && showAlert("Prueba eliminada", "success");
          closeModal && closeModal("pruebaFormModal");
          loadSummary();
          loadPruebas();
        }
      }

      loadSummary();
      loadPruebas();
    </script>
  </body>
</html>
