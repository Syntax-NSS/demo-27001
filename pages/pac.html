<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Acciones Correctivas - Sistema de Gesti√≥n</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/components.css">
    <style>
        body { background-color: var(--color-background); }
        .main-content { margin-left: 90px; }
        .page-title { padding: 20px 40px; background-color: var(--color-background); }
        .page-title h1 { font-size: 32px; font-weight: 600; color: var(--color-text-primary); }
        .content-card { margin: 0 40px 40px 40px; background-color: #ffffff; border-radius: 12px; box-shadow: var(--shadow-sm); overflow: hidden; }
        .card-header-section { background-color: var(--color-secondary); padding: 20px 30px; color: white; font-weight: 600; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        .filters-section { padding: 30px; background-color: #ffffff; border-bottom: 1px solid var(--color-border); }
        .filters-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 2fr auto; gap: 20px; align-items: end; }
    </style>
</head>
<body>
    <div id="sidebar"></div>
    <div class="main-content">
        <div id="header"></div>
        <div id="breadcrumb"></div>
        <div class="page-title">
            <h1>Plan de Acciones Correctivas (PAC)</h1>
        </div>
        <div class="content-card">
            <div class="card-header-section">
                <span>Plan de Acciones Correctivas</span>
                <button class="btn btn-sm" style="background-color: white; color: var(--color-secondary);" onclick="showFormModal()">
                    + Nueva acci√≥n
                </button>
            </div>
            <div class="filters-section">
                <div class="filters-grid">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Estado</label>
                        <select class="form-control" id="filterEstado" onchange="applyFilters()">
                            <option value="">Todos</option>
                            <option value="en_progreso">En progreso</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="revision">En revisi√≥n</option>
                            <option value="cerrada">Cerrada</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Prioridad</label>
                        <select class="form-control" id="filterPrioridad" onchange="applyFilters()">
                            <option value="">Todas</option>
                            <option value="alta">Alta</option>
                            <option value="media">Media</option>
                            <option value="baja">Baja</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Responsable</label>
                        <select class="form-control" id="filterResponsable" onchange="applyFilters()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Buscar</label>
                        <input type="text" class="form-control" id="filterSearch" placeholder="Buscar..." oninput="applyFilters()">
                    </div>
                    <button class="btn btn-secondary" onclick="clearFilters()">Limpiar</button>
                </div>
            </div>
            <div id="pacTableContainer"></div>
        </div>
    </div>

    <!-- Modal Formulario -->
    <div id="pacFormModal" class="modal-overlay" style="display: none;" onclick="closeModalOnOverlayClick(event, 'pacFormModal')">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Nueva Acci√≥n Correctiva</h3>
                <button class="modal-close" onclick="closeModal('pacFormModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="pacForm">
                    <input type="hidden" id="pacId">
                    <div class="form-group">
                        <label class="form-label required">Descripci√≥n</label>
                        <textarea class="form-control" id="descripcion" required rows="3"></textarea>
                        <span class="form-error"></span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label required">Origen</label>
                            <select class="form-control" id="origen" required>
                                <option value="">Seleccionar...</option>
                                <option value="Auditor√≠a Interna">Auditor√≠a Interna</option>
                                <option value="Auditor√≠a Externa">Auditor√≠a Externa</option>
                                <option value="Revisi√≥n Gerencia">Revisi√≥n Gerencia</option>
                                <option value="Incidente Seguridad">Incidente Seguridad</option>
                                <option value="Revisi√≥n Anual">Revisi√≥n Anual</option>
                            </select>
                            <span class="form-error"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Prioridad</label>
                            <select class="form-control" id="prioridad" required>
                                <option value="">Seleccionar...</option>
                                <option value="alta">Alta</option>
                                <option value="media">Media</option>
                                <option value="baja">Baja</option>
                            </select>
                            <span class="form-error"></span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label required">Responsable</label>
                            <input type="text" class="form-control" id="responsable" required>
                            <span class="form-error"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Estado</label>
                            <select class="form-control" id="estado" required>
                                <option value="pendiente">Pendiente</option>
                                <option value="en_progreso">En progreso</option>
                                <option value="revision">En revisi√≥n</option>
                                <option value="cerrada">Cerrada</option>
                            </select>
                            <span class="form-error"></span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label required">Fecha Inicio</label>
                            <input type="date" class="form-control" id="fechaInicio" required>
                            <span class="form-error"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Fecha L√≠mite</label>
                            <input type="date" class="form-control" id="fechaLimite" required>
                            <span class="form-error"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Progreso (%)</label>
                            <input type="number" class="form-control" id="progreso" min="0" max="100" value="0" required>
                            <span class="form-error"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Acciones a realizar</label>
                        <textarea class="form-control" id="acciones" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('pacFormModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="savePAC()">Guardar</button>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/components.js"></script>
    <script>
        document.getElementById('sidebar').innerHTML = renderSidebar('pac');
        document.getElementById('header').innerHTML = renderHeader();
        document.getElementById('breadcrumb').innerHTML = renderBreadcrumb([
            { icon: 'üè†', text: 'Inicio', link: '../index.html' },
            { text: 'Gesti√≥n de Calidad' },
            { text: 'Plan de Acciones Correctivas' }
        ]);

        let currentFilters = {};

        function loadPAC() {
            const data = storage.filter('pac', currentFilters);
            const responsables = [...new Set(storage.getAll('pac').map(p => p.responsable))];
            document.getElementById('filterResponsable').innerHTML = '<option value="">Todos</option>' +
                responsables.map(r => `<option value="${r}">${r}</option>`).join('');

            const tableHTML = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descripci√≥n</th>
                                <th>Origen</th>
                                <th>Prioridad</th>
                                <th>Responsable</th>
                                <th>Fecha inicio</th>
                                <th>Fecha l√≠mite</th>
                                <th>Progreso</th>
                                <th>Estado</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(pac => `
                                <tr>
                                    <td><strong>${pac.id}</strong></td>
                                    <td>${pac.descripcion}</td>
                                    <td>${pac.origen}</td>
                                    <td>${renderPriorityBadge(pac.prioridad)}</td>
                                    <td>${pac.responsable}</td>
                                    <td>${formatDate(pac.fechaInicio)}</td>
                                    <td>${formatDate(pac.fechaLimite)}</td>
                                    <td>${renderProgressBar(pac.progreso)}</td>
                                    <td>${renderEstadoPACBadge(pac.estado)}</td>
                                    <td>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn btn-sm btn-primary" onclick="editPAC('${pac.id}')" title="Editar">‚úèÔ∏è</button>
                                            <button class="btn btn-sm btn-danger" onclick="confirmDeletePAC('${pac.id}')" title="Eliminar">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('pacTableContainer').innerHTML = tableHTML;
        }

        function applyFilters() {
            currentFilters = {
                estado: document.getElementById('filterEstado').value,
                prioridad: document.getElementById('filterPrioridad').value,
                responsable: document.getElementById('filterResponsable').value,
                descripcion: document.getElementById('filterSearch').value
            };
            loadPAC();
        }

        function clearFilters() {
            document.getElementById('filterEstado').value = '';
            document.getElementById('filterPrioridad').value = '';
            document.getElementById('filterResponsable').value = '';
            document.getElementById('filterSearch').value = '';
            currentFilters = {};
            loadPAC();
        }

        function showFormModal(id = null) {
            document.getElementById('modalTitle').textContent = id ? 'Editar Acci√≥n Correctiva' : 'Nueva Acci√≥n Correctiva';
            clearForm('pacForm');

            if (id) {
                const pac = storage.getById('pac', id);
                if (pac) {
                    document.getElementById('pacId').value = pac.id;
                    document.getElementById('descripcion').value = pac.descripcion;
                    document.getElementById('origen').value = pac.origen;
                    document.getElementById('prioridad').value = pac.prioridad;
                    document.getElementById('responsable').value = pac.responsable;
                    document.getElementById('estado').value = pac.estado;
                    document.getElementById('fechaInicio').value = pac.fechaInicio;
                    document.getElementById('fechaLimite').value = pac.fechaLimite;
                    document.getElementById('progreso').value = pac.progreso;
                    document.getElementById('acciones').value = pac.acciones || '';
                }
            }
            openModal('pacFormModal');
        }

        function editPAC(id) {
            showFormModal(id);
        }

        function savePAC() {
            if (!validateForm('pacForm')) return;

            const id = document.getElementById('pacId').value;
            const data = {
                descripcion: document.getElementById('descripcion').value,
                origen: document.getElementById('origen').value,
                prioridad: document.getElementById('prioridad').value,
                responsable: document.getElementById('responsable').value,
                estado: document.getElementById('estado').value,
                fechaInicio: document.getElementById('fechaInicio').value,
                fechaLimite: document.getElementById('fechaLimite').value,
                progreso: parseInt(document.getElementById('progreso').value),
                acciones: document.getElementById('acciones').value
            };

            if (id) {
                storage.update('pac', id, data);
                showAlert('Acci√≥n correctiva actualizada exitosamente', 'success');
            } else {
                storage.create('pac', data);
                showAlert('Acci√≥n correctiva creada exitosamente', 'success');
            }

            closeModal('pacFormModal');
            loadPAC();
        }

        function confirmDeletePAC(id) {
            if (confirm('¬øEst√° seguro de eliminar esta acci√≥n correctiva?')) {
                storage.delete('pac', id);
                showAlert('Acci√≥n correctiva eliminada', 'success');
                loadPAC();
            }
        }

        loadPAC();
    </script>
</body>
</html>
